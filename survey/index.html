<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Construct Item Mapping Survey</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f5f5f5;
            line-height: 1.6;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .header {
            background: linear-gradient(135deg, #8BC34A, #7CB342);
            color: white;
            padding: 25px;
            border-radius: 12px;
            margin-bottom: 30px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        
        .header h1 {
            font-size: 28px;
            margin-bottom: 10px;
        }
        
        .header p {
            font-size: 16px;
            opacity: 0.9;
        }
        
        .progress-bar {
            background: white;
            border-radius: 25px;
            padding: 4px;
            margin: 20px 0;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .progress-fill {
            background: linear-gradient(90deg, #8BC34A, #7CB342);
            height: 12px;
            border-radius: 25px;
            transition: width 0.3s ease;
        }
        
        .construct-navigation {
            display: flex;
            gap: 10px;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }
        
        .construct-tab {
            padding: 12px 24px;
            background: white;
            border: 2px solid #ddd;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 500;
        }
        
        .construct-tab.active {
            background: #8BC34A;
            color: white;
            border-color: #8BC34A;
        }
        
        .construct-tab.completed {
            background: #4CAF50;
            color: white;
            border-color: #4CAF50;
        }
        
        .construct-page {
            display: none;
            background: white;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
        }
        
        .construct-page.active {
            display: block;
        }
        
        .construct-header {
            background: #f8f9fa;
            padding: 20px;
            border-bottom: 2px solid #e9ecef;
        }
        
        .construct-title {
            font-size: 24px;
            color: #333;
            margin-bottom: 10px;
            text-transform: capitalize;
        }
        
        .items-table {
            width: 100%;
            border-collapse: collapse;
        }
        
        .table-header {
            background: #f8f9fa;
            border-bottom: 2px solid #dee2e6;
        }
        
        .table-header th {
            padding: 15px 8px;
            text-align: center;
            font-weight: 600;
            color: #495057;
            font-size: 12px;
            border-right: 1px solid #dee2e6;
        }
        
        .table-header th:first-child {
            text-align: left;
            width: 300px;
        }
        
        .confidence-header {
            background: #8BC34A;
            color: white;
            border-left: 3px solid #7CB342 !important;
        }
        
        .item-row {
            border-bottom: 1px solid #e9ecef;
            transition: background-color 0.2s ease;
        }
        
        .item-row:hover {
            background-color: #f8f9fa;
        }
        
        .item-row td {
            padding: 15px 8px;
            text-align: center;
            vertical-align: middle;
        }
        
        .item-text {
            text-align: left !important;
            background-color: #f8f9fa;
            font-weight: 500;
            color: #333;
            border-right: 2px solid #dee2e6;
            padding-left: 15px !important;
        }
        
        .confidence-column {
            background-color: #f0f8f0;
            border-left: 3px solid #8BC34A;
        }
        
        input[type="radio"] {
            transform: scale(1.3);
            cursor: pointer;
        }
        
        input[type="radio"]:checked {
            accent-color: #8BC34A;
        }
        
        .navigation-buttons {
            display: flex;
            justify-content: space-between;
            margin: 30px 0;
            gap: 20px;
        }
        
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 500;
            transition: all 0.3s ease;
        }
        
        .btn-primary {
            background: #8BC34A;
            color: white;
        }
        
        .btn-primary:hover {
            background: #7CB342;
            transform: translateY(-2px);
        }
        
        .btn-secondary {
            background: #6c757d;
            color: white;
        }
        
        .btn-secondary:hover {
            background: #5a6268;
        }
        
        .btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }
        
        .completion-message {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
            text-align: center;
        }
        
        .download-section {
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            text-align: center;
            margin-top: 30px;
        }
        
        .download-btn {
            background: #28a745;
            color: white;
            padding: 15px 30px;
            border: none;
            border-radius: 8px;
            font-size: 18px;
            cursor: pointer;
            margin: 10px;
            transition: background 0.3s ease;
        }
        
        .download-btn:hover {
            background: #218838;
        }
        
        .loading-message {
            text-align: center;
            padding: 40px;
            font-size: 18px;
            color: #666;
        }
        
        @media (max-width: 768px) {
            .items-table {
                font-size: 10px;
                display: block;
                overflow-x: auto;
                white-space: nowrap;
            }
            
            .table-header th {
                padding: 8px 2px;
                font-size: 8px;
                min-width: 50px;
            }
            
            .table-header th:first-child {
                min-width: 200px;
                font-size: 10px;
            }
            
            .item-row td {
                padding: 8px 2px;
                min-width: 50px;
            }
            
            .item-text {
                min-width: 200px !important;
                font-size: 12px !important;
            }
            
            .construct-navigation {
                flex-direction: column;
            }
            
            .confidence-column-header {
                width: 35px !important;
                min-width: 35px;
                font-size: 9px;
            }
        }
        
        @media (max-width: 1200px) {
            .container {
                max-width: 100%;
                padding: 10px;
            }
            
            .table-header th {
                font-size: 9px;
                padding: 8px 3px;
            }
            
            .table-header th:first-child {
                font-size: 11px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Construct Item Mapping Survey</h1>
            <p>Please assign the following items from various questionnaires to the disorder dimension you think they belong to and judge the confidence of your choice.</p>
            
            <div class="progress-bar">
                <div class="progress-fill" id="progressFill" style="width: 0%;"></div>
            </div>
            <div id="progressText">Loading survey data...</div>
        </div>
        
        <div class="construct-navigation" id="constructTabs">
            <!-- Tabs will be generated here -->
        </div>
        
        <!-- Loading Page -->
        <div class="construct-page active" id="loadingPage">
            <div class="loading-message">
                <h2>Loading Survey Data...</h2>
                <p>Please wait while we load the questionnaire items.</p>
            </div>
        </div>
        
        <!-- Welcome Page -->
        <div class="construct-page" id="welcomePage">
            <div class="construct-header">
                <h2 class="construct-title">Hello!</h2>
            </div>
            <div style="padding: 30px; line-height: 1.8; font-size: 16px;">
                <p><strong>Dear expert,</strong></p>
                <p>with this form we would like to collect your expert opinion on items of mental health questionnaires. For our ENIGMA-PD project on neuropsychiatric symptoms in PD, we need to harmonize multiple mental health questionnaires since not all sites administered the same questionnaires. Once we selected the overlapping dimensions, we can transform the scores and achieve greater harmonization. We believe that by mapping single items to a common construct dimension we can achieve more reliable results and increase power of the brain morphology analysis. Additionally, we hope to create a more general questionnaire harmonization protocol for others to reuse for their own large scale multi-sited study.</p>
                <p>We highly appreciate your input.</p>
                <p><strong>Thank you!</strong></p>
                <div style="text-align: center; margin-top: 40px;">
                    <button class="btn btn-primary" onclick="showInstructions()" style="font-size: 18px; padding: 15px 30px;">Continue</button>
                </div>
            </div>
        </div>
        
        <!-- Instructions Page -->
        <div class="construct-page" id="instructionsPage">
            <div class="construct-header">
                <h2 class="construct-title">Instructions</h2>
            </div>
            <div style="padding: 30px; line-height: 1.8; font-size: 16px;">
                <p>On the following pages you will be presented by items from multiple mental health questionnaires. The items are pre-sorted by mental health construct (e.g., depression, anxiety, psychosis etc.). We also pre-selected construct dimensions based on clinical criteria and/or the theoretical basis of the questionnaires (e.g., for depression you will find dimensions like depressed mood, anhedonia, feelings of guilt etc.).</p>
                <p>Your task will be to <strong>select the radio button</strong> for the dimension you think each item belongs to, and rate your confidence in that choice on a scale from 0 (not confident) to 4 (very confident).</p>
                <p>Please make sure to go through all constructs by clicking on "Next" at the end of each page until you reach the End screen of this form.</p>
                <p><strong>Thank you!</strong></p>
                <div style="text-align: center; margin-top: 40px;">
                    <button class="btn btn-primary" onclick="startSurvey()" style="font-size: 18px; padding: 15px 30px;">Start Survey</button>
                </div>
            </div>
        </div>
        
        <div id="constructPages">
            <!-- Pages will be generated here -->
        </div>
        
        <div class="navigation-buttons" id="navigationButtons" style="display: none;">
            <button class="btn btn-secondary" id="prevBtn" onclick="previousConstruct()">← Previous</button>
            <button class="btn btn-primary" id="nextBtn" onclick="nextConstruct()">Next →</button>
        </div>
        
        <div class="download-section" id="downloadSection" style="display: none;">
            <div class="completion-message">
                <h2>🎉 Survey Completed!</h2>
                <p>Thank you for completing all construct mappings. Please provide some information about your professional background before downloading your responses.</p>
            </div>
            
            <!-- Professional Background Form -->
            <div style="background: #f8f9fa; padding: 30px; border-radius: 12px; margin: 20px 0; text-align: left; max-width: 600px; margin-left: auto; margin-right: auto;">
                <h3 style="margin-bottom: 20px; color: #333; text-align: center;">Professional Background</h3>
                
                <div style="margin-bottom: 25px;">
                    <label style="display: block; font-weight: 600; margin-bottom: 15px; color: #555;">What is your professional background?</label>
                    
                    <div style="margin-bottom: 10px;">
                        <input type="radio" id="psychiatrist" name="profession" value="Psychiatrist" style="margin-right: 8px;">
                        <label for="psychiatrist">Psychiatrist</label>
                    </div>
                    
                    <div style="margin-bottom: 10px;">
                        <input type="radio" id="psychotherapist" name="profession" value="Psychotherapist" style="margin-right: 8px;">
                        <label for="psychotherapist">Psychotherapist</label>
                    </div>
                    
                    <div style="margin-bottom: 10px;">
                        <input type="radio" id="clinical-psychologist" name="profession" value="Clinical Psychologist" style="margin-right: 8px;">
                        <label for="clinical-psychologist">Clinical Psychologist</label>
                    </div>
                    
                    <div style="margin-bottom: 10px;">
                        <input type="radio" id="psychologist-other" name="profession" value="Psychologist, other fields" style="margin-right: 8px;">
                        <label for="psychologist-other">Psychologist, other fields</label>
                    </div>
                    
                    <div style="margin-bottom: 10px;">
                        <input type="radio" id="neurologist" name="profession" value="Neurologist" style="margin-right: 8px;">
                        <label for="neurologist">Neurologist</label>
                    </div>
                    
                    <div style="margin-bottom: 10px;">
                        <input type="radio" id="neuroscientist" name="profession" value="Neuroscientist" style="margin-right: 8px;">
                        <label for="neuroscientist">Neuroscientist</label>
                    </div>
                    
                    <div style="margin-bottom: 10px;">
                        <input type="radio" id="mental-health-other" name="profession" value="Other mental health professional" style="margin-right: 8px;" onchange="toggleSpecifyField('mental-health-specify', this.checked)">
                        <label for="mental-health-other">Other mental health professional:</label>
                        <input type="text" id="mental-health-specify" placeholder="please specify" style="margin-left: 10px; padding: 5px; border: 1px solid #ccc; border-radius: 4px; width: 200px;" disabled>
                    </div>
                    
                    <div style="margin-bottom: 10px;">
                        <input type="radio" id="other" name="profession" value="Other" style="margin-right: 8px;" onchange="toggleSpecifyField('other-specify', this.checked)">
                        <label for="other">Other:</label>
                        <input type="text" id="other-specify" placeholder="free text option" style="margin-left: 10px; padding: 5px; border: 1px solid #ccc; border-radius: 4px; width: 200px;" disabled>
                    </div>
                </div>
                
                <div style="margin-bottom: 25px;">
                    <label for="experience-years" style="display: block; font-weight: 600; margin-bottom: 10px; color: #555;">How many years is your professional experience?</label>
                    <input type="number" id="experience-years" min="0" max="60" style="padding: 8px; border: 1px solid #ccc; border-radius: 4px; width: 100px; font-size: 16px;">
                </div>
            </div>
            
            <div style="text-align: center;">
                <p style="margin: 20px 0; color: #666; font-size: 14px;">
                    Your responses will be automatically submitted when you click the button below.
                </p>
                
                <!-- Test button for debugging -->
                <button class="download-btn" onclick="testButton()" style="background: #007bff; font-size: 14px; padding: 8px 16px; margin-bottom: 10px;">
                    🧪 Test Button (Debug)
                </button>
                <br>
                
                <button class="download-btn" onclick="submitData(); console.log('Button onclick fired');" id="submitBtn" disabled style="background: #ccc; font-size: 18px; padding: 15px 30px;">
                    📤 Submit Survey Responses
                </button>
                
                <!-- Optional backup downloads - smaller and less prominent -->
                <details style="margin-top: 20px;">
                    <summary style="cursor: pointer; color: #666; font-size: 14px;">📄 Optional: Download backup copies</summary>
                    <div style="margin-top: 15px;">
                        <button class="download-btn" onclick="downloadCSV()" id="downloadCsvBtn" disabled style="background: #6c757d; font-size: 12px; padding: 8px 16px;">CSV</button>
                        <button class="download-btn" onclick="downloadJSON()" id="downloadJsonBtn" disabled style="background: #6c757d; font-size: 12px; padding: 8px 16px;">JSON</button>
                    </div>
                </details>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let surveyData = {};
        let constructs = [];
        let currentConstruct = -2; // Start at loading page (-3 = loading, -2 = welcome, -1 = instructions, 0+ = constructs)
        let responses = {};
        let feedback = {};
        
        // Load actual data from CSV file
        async function loadSurveyData() {
            try {
                console.log('Starting to load CSV data...');
                
                // Try multiple possible URLs
                const possibleURLs = [
                    'https://raw.githubusercontent.com/ENIGMA-PD/psych-in-harmony/main/code/similarity-analysis/similarity-analysis-input_without-sleep.csv',
                    'https://raw.githubusercontent.com/ENIGMA-PD/psych-in-harmony/master/code/similarity-analysis/similarity-analysis-input_without-sleep.csv',
                    '../code/similarity-analysis/similarity-analysis-input_without-sleep.csv'
                ];
                
                let csvData = null;
                let successURL = null;
                
                for (let url of possibleURLs) {
                    try {
                        console.log('Trying URL:', url);
                        const response = await fetch(url);
                        
                        if (response.ok) {
                            csvData = await response.text();
                            successURL = url;
                            console.log('Successfully loaded from:', url);
                            break;
                        } else {
                            console.log('Failed with status:', response.status, 'for URL:', url);
                        }
                    } catch (urlError) {
                        console.log('Error with URL:', url, urlError.message);
                    }
                }
                
                if (!csvData) {
                    throw new Error('Could not load CSV from any URL');
                }

                console.log('CSV data loaded from:', successURL);
                console.log('CSV data length:', csvData.length, 'characters');
                console.log('First 200 characters:', csvData.substring(0, 200));
        
                // Parse CSV manually (simple implementation)
                console.log('Parsing CSV data...');
                const lines = csvData.split('\n');
                console.log('Found', lines.length, 'total lines');
                
                if (lines.length === 0) {
                    throw new Error('CSV file appears to be empty');
                }
                
                // Get headers from first line
                const headerLine = lines[0].trim();
                const headers = parseCSVLine(headerLine);
                console.log('Headers:', headers);
                
                // Parse data rows
                const parsed = { data: [] };
                let currentLine = '';
                let inMultiLineField = false;
                
                for (let i = 1; i < lines.length; i++) {
                    const line = lines[i];
                    
                    // Handle multi-line fields (fields with line breaks inside quotes)
                    currentLine += (currentLine ? '\n' : '') + line;
                    
                    // Count quotes to see if we're inside a quoted field
                    const quoteCount = (currentLine.match(/"/g) || []).length;
                    inMultiLineField = quoteCount % 2 !== 0;
                    
                    if (!inMultiLineField && currentLine.trim()) {
                        // Parse this complete line
                        const values = parseCSVLine(currentLine);
                        
                        // Create row object
                        const row = {};
                        headers.forEach((header, index) => {
                            row[header] = values[index] || '';
                        });
                        
                        // Debug specific problematic rows
                        if (i >= 105 && i <= 130) {
                            console.log(`Row ${i}:`, {
                                construct: row.construct,
                                question_text: row.question_text ? row.question_text.substring(0, 50) + '...' : 'MISSING',
                                construct_category: row.construct_category || 'MISSING',
                                raw_values: values.slice(0, 4)
                            });
                        }
                        
                        // Only add rows that have a valid construct
                        if (row.construct && row.construct.trim() && 
                            ['depression', 'anxiety', 'psychosis', 'apathy'].includes(row.construct.toLowerCase().trim())) {
                            parsed.data.push(row);
                        }
                        
                        currentLine = '';
                    }
                }
                
                // Helper function to parse a CSV line properly
                function parseCSVLine(line) {
                    const result = [];
                    let current = '';
                    let inQuotes = false;
                    let i = 0;
                    
                    while (i < line.length) {
                        const char = line[i];
                        const nextChar = line[i + 1];
                        
                        if (char === '"') {
                            if (inQuotes && nextChar === '"') {
                                // Escaped quote inside quoted field
                                current += '"';
                                i += 2;
                                continue;
                            } else {
                                // Start or end of quoted field
                                inQuotes = !inQuotes;
                            }
                        } else if (char === ',' && !inQuotes) {
                            // Field separator
                            result.push(current.trim());
                            current = '';
                        } else {
                            current += char;
                        }
                        i++;
                    }
                    
                    // Add the last field
                    result.push(current.trim());
                    return result;
                }
        
                console.log('Successfully parsed', parsed.data.length, 'rows');
                console.log('Sample of parsed data:', parsed.data.slice(0, 3));
                
                if (!parsed.data || parsed.data.length === 0) {
                    throw new Error('No valid data found in CSV file');
                }
        
                // Organize data by construct
                const organizedData = {};
        
                parsed.data.forEach((row, index) => {
                    const construct = row.construct ? row.construct.toLowerCase().trim() : '';
                    
                    // Only process valid constructs
                    if (!construct || !['depression', 'anxiety', 'psychosis', 'apathy'].includes(construct)) {
                        console.log('Skipping row', index, 'with invalid construct:', construct);
                        return;
                    }
                    
                    // Skip if missing essential data
                    if (!row.question_text || !row.construct_category) {
                        console.log('Skipping row', index, 'missing question_text or construct_category');
                        return;
                    }
            
                    if (!organizedData[construct]) {
                        organizedData[construct] = {
                            items: [],
                            categories: new Set()
                        };
                    }
            
                    organizedData[construct].items.push({
                        id: row.question_number || `item_${index}`,
                        text: row.question_text.trim(),
                        questionnaire: row.questionnaire_name || '',
                        originalCategory: row.construct_category.trim()
                    });
            
                    organizedData[construct].categories.add(row.construct_category.trim());
                });
        
                // Convert sets to arrays and update surveyData
                Object.keys(organizedData).forEach(construct => {
                    surveyData[construct] = {
                        items: organizedData[construct].items,
                        categories: Array.from(organizedData[construct].categories)
                    };
                });
                
                // NOW update constructs array after data is loaded
                constructs = Object.keys(surveyData);
        
                console.log('Survey data organized successfully');
                console.log('Constructs found:', constructs);
                console.log('Items per construct:', constructs.map(c => `${c}: ${surveyData[c].items?.length || 0}`));
                
                if (constructs.length === 0) {
                    throw new Error('No constructs found in data');
                }
        
                // Initialize survey after data is loaded
                initializeSurvey();
                
                // Hide loading page and show welcome page
                document.getElementById('loadingPage').classList.remove('active');
                document.getElementById('welcomePage').classList.add('active');
                currentConstruct = -2;
                
            } catch (error) {
                console.error('Detailed error loading survey data:', error);
                console.error('Error stack:', error.stack);
        
                // Show detailed error message to user
                document.querySelector('.header h1').textContent = 'Error Loading Survey Data';
                document.querySelector('.header p').textContent = 'Failed to load survey items. Please check console for details.';
                document.getElementById('progressText').textContent = 'Error loading data';
                
                // Show detailed error in loading page
                document.getElementById('loadingPage').innerHTML = `
                    <div class="loading-message">
                        <h2 style="color: #dc3545;">❌ Error Loading Survey</h2>
                        <p><strong>Error:</strong> ${error.message}</p>
                        <p>Please check your internet connection and try again.</p>
                        <p><small>Check browser console (F12) for more details.</small></p>
                        <button class="btn btn-primary" onclick="location.reload()" style="margin-top: 20px;">🔄 Retry</button>
                    </div>
                `;
            }
        }
        
        function showInstructions() {
            document.getElementById('welcomePage').classList.remove('active');
            document.getElementById('instructionsPage').classList.add('active');
            currentConstruct = -1;
        }
        
        function startSurvey() {
            document.getElementById('instructionsPage').classList.remove('active');
            document.getElementById('navigationButtons').style.display = 'flex';
            showConstruct(0);
        }
        
        function initializeSurvey() {
            createTabs();
            createPages();
            updateProgress();
        }
        
        function createTabs() {
            const tabContainer = document.getElementById('constructTabs');
            tabContainer.innerHTML = '';
            
            constructs.forEach((construct, index) => {
                const tab = document.createElement('div');
                tab.className = 'construct-tab';
                tab.textContent = construct.charAt(0).toUpperCase() + construct.slice(1);
                tab.onclick = () => showConstruct(index);
                tab.id = `tab-${index}`;
                tabContainer.appendChild(tab);
            });
        }
        
        function createPages() {
            const pageContainer = document.getElementById('constructPages');
            pageContainer.innerHTML = '';
            
            constructs.forEach((construct, constructIndex) => {
                const page = document.createElement('div');
                page.className = 'construct-page';
                page.id = `page-${constructIndex}`;
                
                const data = surveyData[construct];
                if (!data || !data.items) {
                    page.innerHTML = `<div class="construct-header"><h2>No data available for ${construct}</h2></div>`;
                    pageContainer.appendChild(page);
                    return;
                }
                
                let tableHTML = `
                    <div class="construct-header">
                        <h2 class="construct-title">${construct}</h2>
                        <p>Items: ${data.items.length} | Categories: ${data.categories.length}</p>
                    </div>
                    <table class="items-table">
                        <thead class="table-header">
                            <tr>
                                <th>Item</th>
                `;
                
                // Add category columns
                data.categories.forEach(category => {
                    tableHTML += `<th>${category}</th>`;
                });
                
                // Add confidence columns
                tableHTML += `
                                <th class="confidence-header" colspan="5">Confidence</th>
                            </tr>
                            <tr>
                                <th></th>
                `;
                
                // Add empty cells for categories
                data.categories.forEach(category => {
                    tableHTML += `<th></th>`;
                });
                
                // Add confidence scale numbers
                tableHTML += `
                                <th class="confidence-header">0</th>
                                <th class="confidence-header">1</th>
                                <th class="confidence-header">2</th>
                                <th class="confidence-header">3</th>
                                <th class="confidence-header">4</th>
                            </tr>
                        </thead>
                        <tbody>
                `;
                
                // Add item rows
                data.items.forEach((item, itemIndex) => {
                    const itemId = `${construct}_${itemIndex}`;
                    tableHTML += `
                        <tr class="item-row">
                            <td class="item-text">
                                ${item.text}
                            </td>
                    `;
                    
                    // Category radio buttons
                    data.categories.forEach((category, catIndex) => {
                        tableHTML += `
                            <td>
                                <input type="radio" name="category_${itemId}" value="${category}" 
                                       onchange="updateResponse('${itemId}', 'category', '${category}')">
                            </td>
                        `;
                    });
                    
                    // Confidence radio buttons
                    for (let conf = 0; conf <= 4; conf++) {
                        tableHTML += `
                            <td class="confidence-column">
                                <input type="radio" name="confidence_${itemId}" value="${conf}"
                                       onchange="updateResponse('${itemId}', 'confidence', ${conf})">
                            </td>
                        `;
                    }
                    
                    tableHTML += '</tr>';
                });
                
                tableHTML += '</tbody></table>';
                
                // Add feedback section
                tableHTML += `
                    <div style="background: #f8f9fa; border-top: 3px solid #8BC34A; padding: 25px; margin-top: 30px;">
                        <h4 style="color: #333; margin-bottom: 15px; font-size: 16px;">💬 Optional Feedback</h4>
                        <p style="color: #666; margin-bottom: 15px; font-size: 14px;">Do you want to provide some feedback on this section? This could be anything, such as thoughts on the dimensions or additional considerations for us to take into account.</p>
                        <textarea id="feedback_${construct}" 
                                  placeholder="Share your thoughts about the ${construct} construct dimensions, items, or any other considerations..."
                                  style="width: 100%; min-height: 100px; padding: 12px; border: 1px solid #ddd; border-radius: 6px; font-family: inherit; font-size: 14px; resize: vertical;"
                                  oninput="saveFeedback('${construct}', this.value)"></textarea>
                    </div>
                `;
                
                page.innerHTML = tableHTML;
                pageContainer.appendChild(page);
            });
        }
        
        function showConstruct(index) {
            // Hide welcome and instructions pages
            document.getElementById('welcomePage').classList.remove('active');
            document.getElementById('instructionsPage').classList.remove('active');
            document.getElementById('loadingPage').classList.remove('active');
            
            // Hide all construct pages
            document.querySelectorAll('#constructPages .construct-page').forEach(page => {
                page.classList.remove('active');
            });
            
            // Remove active class from all tabs
            document.querySelectorAll('.construct-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Show selected page and tab
            document.getElementById(`page-${index}`).classList.add('active');
            document.getElementById(`tab-${index}`).classList.add('active');
            
            currentConstruct = index;
            updateNavigationButtons();
            updateProgress();
        }
        
        function updateResponse(itemId, type, value) {
            if (!responses[itemId]) {
                responses[itemId] = {};
            }
            responses[itemId][type] = value;
            updateProgress();
            checkConstructCompletion();
        }
        
        function saveFeedback(construct, feedbackText) {
            feedback[construct] = feedbackText;
        }
        
        function checkConstructCompletion() {
            if (currentConstruct < 0 || !constructs[currentConstruct]) return;
            
            const construct = constructs[currentConstruct];
            const data = surveyData[construct];
            
            if (!data || !data.items) return;
            
            let allComplete = true;
            data.items.forEach((item, index) => {
                const itemId = `${construct}_${index}`;
                if (!responses[itemId] || !responses[itemId].category || responses[itemId].confidence === undefined) {
                    allComplete = false;
                }
            });
            
            if (allComplete) {
                document.getElementById(`tab-${currentConstruct}`).classList.add('completed');
            }
        }
        
        function updateProgress() {
            let totalItems = 0;
            let completedItems = 0;
            
            constructs.forEach((construct, constructIndex) => {
                const data = surveyData[construct];
                if (!data || !data.items) return;
                
                data.items.forEach((item, itemIndex) => {
                    totalItems++;
                    const itemId = `${construct}_${itemIndex}`;
                    if (responses[itemId] && responses[itemId].category && responses[itemId].confidence !== undefined) {
                        completedItems++;
                    }
                });
            });
            
            const percentage = totalItems > 0 ? (completedItems / totalItems) * 100 : 0;
            document.getElementById('progressFill').style.width = percentage + '%';
            document.getElementById('progressText').textContent = `${completedItems} of ${totalItems} items completed`;
            
            // DO NOT automatically show download section when all completed
            // Users must click "Finish Survey" to proceed to professional background
            console.log(`Progress: ${completedItems}/${totalItems} items completed (${percentage.toFixed(1)}%)`);
        }
        
        function updateNavigationButtons() {
            const prevBtn = document.getElementById('prevBtn');
            const nextBtn = document.getElementById('nextBtn');
            
            if (!prevBtn || !nextBtn) {
                console.log('Navigation buttons not found');
                return;
            }
            
            console.log('Updating navigation buttons. Current construct:', currentConstruct, 'Total constructs:', constructs.length);
            
            prevBtn.disabled = currentConstruct === 0;
            nextBtn.disabled = false; // Never disable next button - let users navigate
            
            // Update button text for last page
            if (currentConstruct === constructs.length - 1) {
                nextBtn.textContent = 'Finish Survey';
                nextBtn.onclick = () => {
                    console.log('Finish Survey button clicked');
                    finishSurvey();
                };
                console.log('Set button to "Finish Survey" mode');
            } else {
                nextBtn.textContent = 'Next →';
                nextBtn.onclick = () => nextConstruct();
                console.log('Set button to "Next" mode');
            }
            
            console.log('Navigation buttons updated. Next button disabled:', nextBtn.disabled);
        }
        
        function finishSurvey() {
            console.log('finishSurvey() called - User clicked Finish Survey button');
            
            // Hide navigation and construct pages
            document.getElementById('navigationButtons').style.display = 'none';
            document.querySelectorAll('#constructPages .construct-page').forEach(page => {
                page.classList.remove('active');
            });
            document.querySelectorAll('.construct-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // NOW show the download section with professional background
            console.log('Showing professional background form');
            document.getElementById('downloadSection').style.display = 'block';
            
            console.log('About to setup professional background listeners...');
            // Add event listeners for professional background form
            setupProfessionalBackgroundListeners();
            
            // Also do an initial form check
            setTimeout(() => {
                console.log('Running initial form completion check...');
                checkFormCompletion();
            }, 100);
        }
        
        function setupProfessionalBackgroundListeners() {
            console.log('Setting up professional background listeners...');
            
            // Remove existing listeners first to avoid duplicates
            const existingListeners = document.querySelectorAll('[data-listener-added]');
            existingListeners.forEach(el => el.removeAttribute('data-listener-added'));
            
            // Listen for profession selection changes
            document.querySelectorAll('input[name="profession"]').forEach(radio => {
                if (!radio.hasAttribute('data-listener-added')) {
                    radio.addEventListener('change', () => {
                        console.log('Profession changed to:', radio.value);
                        checkFormCompletion();
                    });
                    radio.setAttribute('data-listener-added', 'true');
                }
            });
            
            // Listen for experience years input
            const experienceInput = document.getElementById('experience-years');
            if (experienceInput && !experienceInput.hasAttribute('data-listener-added')) {
                experienceInput.addEventListener('input', () => {
                    console.log('Experience years changed to:', experienceInput.value);
                    checkFormCompletion();
                });
                experienceInput.setAttribute('data-listener-added', 'true');
            }
            
            // Listen for text field changes
            const mentalHealthSpecify = document.getElementById('mental-health-specify');
            const otherSpecify = document.getElementById('other-specify');
            
            if (mentalHealthSpecify && !mentalHealthSpecify.hasAttribute('data-listener-added')) {
                mentalHealthSpecify.addEventListener('input', checkFormCompletion);
                mentalHealthSpecify.setAttribute('data-listener-added', 'true');
            }
            if (otherSpecify && !otherSpecify.hasAttribute('data-listener-added')) {
                otherSpecify.addEventListener('input', checkFormCompletion);
                otherSpecify.setAttribute('data-listener-added', 'true');
            }
            
            console.log('Professional background listeners set up complete');
            
            // Run initial check
            checkFormCompletion();
        }
        
        // Also set up listeners when download section becomes visible
        function initializeDownloadSectionListeners() {
            const downloadSection = document.getElementById('downloadSection');
            if (downloadSection && downloadSection.style.display === 'block') {
                setupProfessionalBackgroundListeners();
            }
        }
        
        // Call this periodically to ensure listeners are set up
        setInterval(() => {
            const downloadSection = document.getElementById('downloadSection');
            if (downloadSection && downloadSection.style.display === 'block') {
                const professionRadios = document.querySelectorAll('input[name="profession"]');
                const hasListeners = Array.from(professionRadios).some(radio => 
                    radio.hasAttribute('data-listener-added')
                );
                if (!hasListeners) {
                    console.log('Download section visible but no listeners found, setting up...');
                    setupProfessionalBackgroundListeners();
                }
            }
        }, 1000);
        
        function toggleSpecifyField(fieldId, isEnabled) {
            const field = document.getElementById(fieldId);
            field.disabled = !isEnabled;
            if (!isEnabled) {
                field.value = '';
            }
            checkFormCompletion();
        }
        
        function checkFormCompletion() {
            console.log('Checking form completion...');
            const selectedProfession = document.querySelector('input[name="profession"]:checked');
            const experienceYears = document.getElementById('experience-years').value;
            
            console.log('Selected profession:', selectedProfession?.value);
            console.log('Experience years:', experienceYears);
            
            let isComplete = false;
            
            if (selectedProfession && experienceYears) {
                // Check if special text fields are required and filled
                if (selectedProfession.value === 'Other mental health professional') {
                    const specifyField = document.getElementById('mental-health-specify').value.trim();
                    isComplete = specifyField.length > 0;
                    console.log('Mental health specify field:', specifyField);
                } else if (selectedProfession.value === 'Other') {
                    const specifyField = document.getElementById('other-specify').value.trim();
                    isComplete = specifyField.length > 0;
                    console.log('Other specify field:', specifyField);
                } else {
                    isComplete = true;
                }
            }
            
            console.log('Form is complete:', isComplete);
            
            // Enable/disable buttons
            const submitBtn = document.getElementById('submitBtn');
            const csvBtn = document.getElementById('downloadCsvBtn');
            const jsonBtn = document.getElementById('downloadJsonBtn');
            
            if (isComplete) {
                submitBtn.disabled = false;
                submitBtn.style.background = '#28a745';
                csvBtn.disabled = false;
                csvBtn.style.background = '#6c757d';
                jsonBtn.disabled = false;
                jsonBtn.style.background = '#6c757d';
                console.log('Buttons enabled');
            } else {
                submitBtn.disabled = true;
                submitBtn.style.background = '#ccc';
                csvBtn.disabled = true;
                csvBtn.style.background = '#ccc';
                jsonBtn.disabled = true;
                jsonBtn.style.background = '#ccc';
                console.log('Buttons disabled');
            }
        }
        
        // Test function to verify button works
        function testButton() {
            console.log('TEST: Button is clickable and JavaScript is working');
            alert('Button test successful! JavaScript is working.');
        }
        
        async function submitData() {
            try {
                console.log('=== SUBMIT FUNCTION CALLED ===');
                console.log('Submit button clicked - submitting to Google Sheets only');
                console.log('Responses:', Object.keys(responses).length, 'items');
                console.log('Constructs:', constructs);
                console.log('Feedback:', feedback);
                
                // Show loading state
                const submitBtn = document.getElementById('submitBtn');
                if (!submitBtn) {
                    console.error('Submit button not found!');
                    return;
                }
                
                const originalText = submitBtn.textContent;
                submitBtn.textContent = '📤 Submitting...';
                submitBtn.disabled = true;
                
                console.log('About to call submitToGoogleSheets...');
                
                // Submit to Google Sheets
                await submitToGoogleSheets();
                
                // Show success message
                submitBtn.textContent = '✅ Successfully Submitted!';
                submitBtn.style.background = '#28a745';
                
                // Show completion message
                setTimeout(() => {
                    alert('Thank you! Your survey responses have been successfully submitted.');
                }, 500);
                
            } catch (error) {
                console.error('Error in submitData:', error);
                console.error('Error stack:', error.stack);
                
                // Reset button and show error
                const submitBtn = document.getElementById('submitBtn');
                if (submitBtn) {
                    submitBtn.textContent = '❌ Submission Failed - Retry';
                    submitBtn.style.background = '#dc3545';
                    submitBtn.disabled = false;
                }
                
                alert('Submission failed: ' + error.message + '\nPlease try again or use the backup download options below.');
            }
        }
        
        async function submitDataAndDownload() {
            // Legacy function - just calls submit and download
            await submitData();
            setTimeout(() => {
                downloadCSV();
            }, 1000);
        }
        
        function getProfessionalBackground() {
            const selectedProfession = document.querySelector('input[name="profession"]:checked');
            const experienceYears = document.getElementById('experience-years').value;
            
            let profession = selectedProfession ? selectedProfession.value : '';
            
            // Add specification for "other" options
            if (profession === 'Other mental health professional') {
                const specify = document.getElementById('mental-health-specify').value.trim();
                profession += specify ? `: ${specify}` : '';
            } else if (profession === 'Other') {
                const specify = document.getElementById('other-specify').value.trim();
                profession += specify ? `: ${specify}` : '';
            }
            
            return {
                profession: profession,
                experience_years: experienceYears
            };
        }
        
        function previousConstruct() {
            if (currentConstruct > 0) {
                showConstruct(currentConstruct - 1);
            }
        }
        
        function nextConstruct() {
            if (currentConstruct < constructs.length - 1) {
                showConstruct(currentConstruct + 1);
            }
        }
        
        // Google Sheets configuration
        const GOOGLE_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbwbWz-FmPKJnBmZHddQYs8G11DTQ444j0tn1ZaXaD4DqOWsXopxuz9RndpL7Nd1WP96gg/exec';
        
        async function submitToGoogleSheets() {
            const professionalBackground = getProfessionalBackground();
            
            const submissionData = {
                timestamp: new Date().toISOString(),
                responses: responses,
                feedback: feedback,
                items: surveyData,
                professional_background: professionalBackground
            };
            
            try {
                const response = await fetch(GOOGLE_SCRIPT_URL, {
                    method: 'POST',
                    mode: 'no-cors',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(submissionData)
                });
                
                // Show success message
                showSubmissionStatus(true);
                
            } catch (error) {
                console.error('Error submitting to Google Sheets:', error);
                showSubmissionStatus(false);
            }
        }
        
        function showSubmissionStatus(success) {
            const statusDiv = document.createElement('div');
            statusDiv.style.cssText = `
                position: fixed; top: 20px; right: 20px; padding: 15px 25px;
                border-radius: 8px; color: white; font-weight: bold; z-index: 1000;
                ${success ? 'background: #28a745;' : 'background: #dc3545;'}
            `;
            statusDiv.textContent = success ? 
                '✅ Data submitted successfully!' : 
                '❌ Submission failed. Please download backup files.';
            
            document.body.appendChild(statusDiv);
            
            setTimeout(() => {
                document.body.removeChild(statusDiv);
            }, 5000);
        }
        
        function downloadCSV() {
            try {
                console.log('Download CSV clicked');
                console.log('Constructs available:', constructs);
                console.log('Responses count:', Object.keys(responses).length);
                
                const professionalBackground = getProfessionalBackground();
                console.log('Professional background:', professionalBackground);
                
                const csvData = [];
                const headers = ['construct', 'item_id', 'item_text', 'questionnaire', 'original_category', 'assigned_category', 'confidence', 'expert_profession', 'expert_experience_years', 'construct_feedback'];
                csvData.push(headers.join(','));
                
                let totalRows = 0;
                
                constructs.forEach(construct => {
                    const data = surveyData[construct];
                    if (!data || !data.items) {
                        console.log('No data for construct:', construct);
                        return;
                    }
                    
                    const constructFeedback = feedback[construct] || '';
                    
                    data.items.forEach((item, index) => {
                        const itemId = `${construct}_${index}`;
                        const response = responses[itemId] || {};
                        
                        const row = [
                            construct,
                            item.id || '',
                            `"${(item.text || '').replace(/"/g, '""')}"`,
                            item.questionnaire || '',
                            item.originalCategory || '',
                            response.category || '',
                            response.confidence !== undefined ? response.confidence : '',
                            `"${professionalBackground.profession.replace(/"/g, '""')}"`,
                            professionalBackground.experience_years || '',
                            `"${constructFeedback.replace(/"/g, '""')}"`
                        ];
                        csvData.push(row.join(','));
                        totalRows++;
                    });
                });
                
                console.log('Generated CSV with', totalRows, 'rows');
                
                if (totalRows === 0) {
                    alert('No survey data to download. Please complete some survey items first.');
                    return;
                }
                
                downloadFile(csvData.join('\n'), 'construct_mapping_results.csv', 'text/csv');
                console.log('CSV download initiated');
            } catch (error) {
                console.error('Error in downloadCSV:', error);
                alert('Error creating CSV file: ' + error.message);
            }
        }
        
        function downloadJSON() {
            try {
                console.log('Download JSON clicked');
                const professionalBackground = getProfessionalBackground();
                const jsonData = {
                    metadata: {
                        timestamp: new Date().toISOString(),
                        totalItems: Object.keys(responses).length,
                        constructs: constructs,
                        expert_profession: professionalBackground.profession,
                        expert_experience_years: professionalBackground.experience_years
                    },
                    responses: responses,
                    feedback: feedback,
                    items: surveyData,
                    professional_background: professionalBackground
                };
                
                downloadFile(JSON.stringify(jsonData, null, 2), 'construct_mapping_results.json', 'application/json');
                console.log('JSON download initiated');
            } catch (error) {
                console.error('Error in downloadJSON:', error);
                alert('Error creating JSON file: ' + error.message);
            }
        }
        
        function downloadFile(content, filename, contentType) {
            try {
                console.log('Creating download for:', filename, 'Content length:', content.length);
                const blob = new Blob([content], { type: contentType });
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = filename;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                window.URL.revokeObjectURL(url);
                console.log('File download completed');
            } catch (error) {
                console.error('Error in downloadFile:', error);
                alert('Error downloading file: ' + error.message);
            }
        }
        
        // Initialize the survey when the page loads
        document.addEventListener('DOMContentLoaded', loadSurveyData);
    </script>
</body>
</html>